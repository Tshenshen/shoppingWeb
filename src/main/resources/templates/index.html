<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
>
<head>
    <title id="s">购物网站ShopWeb</title>
    <script th:src="@{/js/jquery-3.4.1.js}"></script>
    <script th:src="@{/webjars/vue/2.6.11/dist/vue.js}"></script>
    <script th:src="@{/webjars/element-ui/2.13.0/lib/index.js}"></script>
    <script th:src="@{/js/bootstrap.js}"></script>
    <script th:src="@{/js/axios.min.js}"></script>
    <link th:href="@{/webjars/element-ui/2.13.0/lib/theme-chalk/index.css}" rel="stylesheet">
    <link th:href="@{/css/bootstrap.css}" rel="stylesheet">
    <link th:href="@{/css/index.css}" rel="stylesheet"/>

</head>
<body>
<div th:replace="toolBar/topNavBar :: topNavBar"></div>
<div id="app" style="margin: auto;width: 79%">
    <div class="search-frag">
        <!--bread-bar-->
        <div class="bread-bar">
            <div class="dictionary-name">
                当前位置：
            </div>
            <el-breadcrumb separator-class="el-icon-arrow-right" style="margin-left: 60px">
                <el-breadcrumb-item>
                    <a th:href="@{/}">首页</a>
                </el-breadcrumb-item>

                <el-breadcrumb-item v-if="shopSearchInfo.type.length > 0">
                    <a @click="searchWithType()">{{curType.name}}</a>
                </el-breadcrumb-item>

                <el-breadcrumb-item v-if="shopSearchInfo.style.length > 0">
                    <a @click="searchWithStyle()">{{curStyle.name}}</a>
                </el-breadcrumb-item>

                <el-breadcrumb-item v-if="shopSearchInfo.keyword.length > 0">
                    <a @click="searchWithKeyword">{{shopSearchInfo.keyword}}</a>
                </el-breadcrumb-item>
            </el-breadcrumb>
        </div>
        <div class="dictionary-bar">
            <div class="dictionary-name">
                商品类别：
            </div>
            <div class="dictionary-value">
                <el-link type="primary"
                         class="dictionary-value-item"
                         v-for="(type,index) in typeDic"
                         :key="index"
                         @click="searchWithType(index)"
                         :disabled="type.id === shopSearchInfo.type">
                    {{type.name}}
                </el-link>
            </div>
        </div>
        <div class="dictionary-bar" v-if="shopSearchInfo.type.length > 0">
            <div class="dictionary-name">
                商品类型：
            </div>
            <div class="dictionary-value">
                <el-link type="primary"
                         class="dictionary-value-item"
                         v-for="(style,index) in styleDic"
                         :key="index"
                         @click="searchWithStyle(index)"
                         :disabled="style.id === shopSearchInfo.style">
                    {{style.name}}
                </el-link>
            </div>
        </div>
        <div class="search-bar">
            <div>
                搜索商品：
                <input v-model="keyword" style="width: 35%">
                <el-button size="mini" type="danger" @click="searchWithKeyword(keyword)">搜索</el-button>
            </div>
        </div>
    </div>

    <!--商品列表-->
    <div v-if="pageInfo.total === 0" style="color: red;text-align: center">
        抱歉，未搜索到相关的店铺
    </div>
    <div>
        <div class="view grid-nosku ">
            <div class="product" v-for="(shop,index) in pageInfo.list" :key="index">
                <div class="product-iWrap">
                    <a class="productImg-wrap" :href="'detailPage?shopId=' + shop.id" target="_blank">
                        <img :src="imgUrl(shop.id, shop.images)" style="object-fit: fill;height: 100%;width: 100%"/>
                    </a>
                    <div class="productPrice">
                        &yen;{{shop.price}}
                    </div>
                    <div class="productTittle">
                        <a :href="'detailPage?shopId=' + shop.id" target="_blank">
                            {{shop.name}}</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--分页-->
    <div style="display: inline-flex;  width: 100%">
        <el-pagination
                v-if="pageInfo.total > 10"
                style="margin: auto"
                background
                layout="prev, pager, next"
                :total="pageInfo.total"
                @current-change="pageChange">
        </el-pagination>
    </div>
</div>
</body>
<script th:src="@{/js/toolBar/topNavBar.js}"></script>
<script>
    new Vue({
        el: "#app",
        data: {
            shopSearchInfo: {
                type: '',
                style: '',
                keyword: '',
                pageNum: '1'
            },
            keyword: '',
            curType: {},
            curStyle: {},
            typeDic: [],
            styleDic: [],
            pageInfo: {
                list: []
            }
        },
        mounted() {
            var _that = this;
            _that.pageChange(1);
            _that.getTypeDic();
        },
        computed: {
            imgUrl() {
                return function (shopId, images) {
                    if (images.split(",")[0].length > 0) {
                        return "/ShopWeb/image/" + shopId + "/" + images.split(",")[0];
                    } else {
                        return ""
                    }
                }
            }
        },
        methods: {
            pageChange(curPage) {
                var _that = this;
                _that.shopSearchInfo.pageNum = curPage;
                _that.getShopListBySearchInfo()
            },
            getShopListBySearchInfo() {
                var _that = this;
                _that.keyword = _that.shopSearchInfo.keyword;
                axios({
                    method: "get",
                    url: "getShopListBySearchInfo",
                    params: _that.shopSearchInfo
                }).then(function (value) {
                    if (value.data.success) {
                        _that.pageInfo = value.data.content;
                    } else {
                        _that.$message.error(value.data.message);
                    }
                }).catch(function (reason) {
                    console.log(reason);
                    _that.$message.error("获取店铺列表错误！");
                });
            },
            searchWithType(index) {
                if (index !== undefined) {
                    this.curType = this.typeDic[index];
                    this.shopSearchInfo.type = this.curType.id;
                    this.styleDic = this.getStyleDic();
                } else {
                    this.shopSearchInfo.keyword = '';
                }
                this.shopSearchInfo.style = '';
                this.getShopListBySearchInfo()
            },
            searchWithStyle(index) {
                if (index !== undefined) {
                    this.curStyle = this.styleDic[index];
                    this.shopSearchInfo.style = this.curStyle.id;
                } else {
                    this.shopSearchInfo.keyword = '';
                }
                this.getShopListBySearchInfo()
            },
            searchWithKeyword(keyword) {
                if (keyword !== undefined) {
                    this.shopSearchInfo.keyword = keyword;
                }
                this.getShopListBySearchInfo()
            },
            getTypeDic() {
                var _that = this;
                axios.get("/ShopWeb/dictionary/getDictionaryListByRootValue?value=TYPE_DIC").then(function (value) {
                    if (value.data.success) {
                        _that.typeDic = value.data.content;
                    } else {
                        _that.$message.error(value.data.message);
                    }
                }).catch(function (reason) {
                    console.log(reason);
                    _that.$message.error("获取种类字典错误！")
                })
            },
            getStyleDic() {
                var _that = this;
                axios({
                    method: "get",
                    url: "/ShopWeb/dictionary/getDictionaryListByParentId",
                    params: {
                        parentId: _that.shopSearchInfo.type
                    }
                }).then(function (value) {
                    if (value.data.success) {
                        _that.styleDic = value.data.content;
                    } else {
                        _that.$message.error(value.data.message);
                    }
                }).catch(function (reason) {
                    console.log(reason);
                    _that.$message.error("获取类型字典错误！")
                })
            }
        }

    })
</script>
</html>

